  setup-heavy-instance:
    runs-on: linux_cpu_light
    steps:
      - name: Manual Checkout
        run: |
          echo "‚¨áÔ∏è Cloning repository manually..."
          git clone --depth 1 https://git:${{ github.token }}@gitea.innosol.online/${{ github.repository }}.git .
          
      - name: Report Status (Pending)
        if: always() && secrets.GITHUB_MIRROR_TOKEN != ''
        run: |
          python scripts/ci/github_status.py \
            --token "${{ secrets.GITHUB_MIRROR_TOKEN }}" \
            --owner "innosol-online-OU" \
            --repo "safesapce" \
            --sha "${{ github.sha }}" \
            --state "pending" \
            --url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_number }}" \
            --context "Gitea/Heavy-Validation" \
            --desc "Waking up Heavy Server (Unshelving)..."

      - name: Wake Up Heavy Server
        env:
          OVH_APP_KEY: ${{ secrets.OVH_APP_KEY }}
          OVH_APP_SECRET: ${{ secrets.OVH_APP_SECRET }}
          OVH_CONSUMER_KEY: ${{ secrets.OVH_CONSUMER_KEY }}
          OVH_PROJECT_ID: ${{ secrets.OVH_PROJECT_ID }}
          OVH_INSTANCE_ID: ${{ secrets.OVH_INSTANCE_ID }}
        run: |
          echo "üöÄ Waking up Heavy Instance..."
          pip install ovh
          python scripts/maintenance/ovh_controller.py wake

  heavy-validation:
    needs: setup-heavy-instance
    runs-on: linux_cpu_heavy
    steps:
      - name: Manual Checkout (vRack)
        run: |
          echo "‚¨áÔ∏è Cloning repository via vRack (10.1.0.61)..."
          git clone --depth 1 http://git:${{ github.token }}@10.1.0.61/${{ github.repository }}.git .
          echo "‚úÖ Checkout complete"

      - name: Build Test Environment
        run: |
          echo "üê≥ Building CI Image..."
          docker build --no-cache --network=host -t safespace-ci:latest -f Dockerfile.ci .

      - name: Run Verification
        run: |
          echo "üß™ Running Full Pipeline Verification..."
          docker run --rm \
            safespace-ci:latest \
            python tests/verify_full_pipeline.py

      - name: Report Status (Success)
        if: success() && secrets.GITHUB_MIRROR_TOKEN != ''
        run: |
          python scripts/ci/github_status.py \
            --token "${{ secrets.GITHUB_MIRROR_TOKEN }}" \
            --owner "innosol-online-OU" \
            --repo "safesapce" \
            --sha "${{ github.sha }}" \
            --state "success" \
            --url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_number }}" \
            --context "Gitea/Heavy-Validation" \
            --desc "All Heavy Tests passed!"

      - name: Report Status (Failure)
        if: failure() && secrets.GITHUB_MIRROR_TOKEN != ''
        run: |
          python scripts/ci/github_status.py \
            --token "${{ secrets.GITHUB_MIRROR_TOKEN }}" \
            --owner "innosol-online-OU" \
            --repo "safesapce" \
            --sha "${{ github.sha }}" \
            --state "failure" \
            --url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_number }}" \
            --context "Gitea/Heavy-Validation" \
            --desc "Heavy Verification Failed!"

  teardown-heavy-instance:
    needs: [heavy-validation, setup-heavy-instance]
    if: always()
    runs-on: linux_cpu_light
    steps:
      - name: Manual Checkout
        run: |
          echo "‚¨áÔ∏è Cloning repository manually..."
          git clone --depth 1 https://git:${{ github.token }}@gitea.innosol.online/${{ github.repository }}.git .

      - name: Sleep Heavy Server
        env:
          OVH_APP_KEY: ${{ secrets.OVH_APP_KEY }}
          OVH_APP_SECRET: ${{ secrets.OVH_APP_SECRET }}
          OVH_CONSUMER_KEY: ${{ secrets.OVH_CONSUMER_KEY }}
          OVH_PROJECT_ID: ${{ secrets.OVH_PROJECT_ID }}
          OVH_INSTANCE_ID: ${{ secrets.OVH_INSTANCE_ID }}
        run: |
          echo "üò¥ Suspending Heavy Instance..."
          pip install ovh
          python scripts/maintenance/ovh_controller.py sleep

