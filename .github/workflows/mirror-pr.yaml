name: Bridge to Private CI

on:
  pull_request:
    types: [labeled, synchronize]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write
  statuses: write

jobs:
  mirror-to-gitea:
    if: contains(github.event.pull_request.labels.*.name, 'safe-to-test')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Public PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Push to Gitea
        env:
          TARGET: "https://${{ secrets.GITEA_USER }}:${{ secrets.GITEA_TOKEN }}@${{ secrets.GITEA_HOST }}/${{ secrets.GITEA_USER }}/safespace.git"
          BRANCH: "pr-${{ github.event.number }}"
        run: |
          git config --global user.email "bot@innosol.online"
          git config --global user.name "Bridge Bot"
          git checkout -b $BRANCH
          echo "ðŸš€ Pushing..."
          git push -f "$TARGET" $BRANCH

      - name: Comment
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: "âœ… **Mirrored to Gitea**\nStatus: Pending Internal CI."
            })

      - name: Pre-Register Checks
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.MIRROR_TOKEN }}
          script: |
            const checks = ['Gitea/Fast-Feedback', 'Gitea/Heavy-Validation'];
            for (const c of checks) {
              await github.rest.repos.createCommitStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha: context.payload.pull_request.head.sha,
                state: 'pending',
                context: c,
                description: 'Waiting...'
              });
            }
