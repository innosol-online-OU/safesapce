name: Bridge to Private CI

on:
  pull_request:
    types: [labeled, synchronize]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  mirror-to-gitea:
    if: contains(github.event.pull_request.labels.*.name, 'safe-to-test')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Public PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Push to Gitea
        env:
          # Constructs the secure URL using your secrets
          TARGET_URL: "https://${{ secrets.GITEA_USER }}:${{ secrets.GITEA_TOKEN }}@${{ secrets.GITEA_HOST }}/${{ secrets.GITEA_USER }}/safespace.git"
          PR_BRANCH: "pr-${{ github.event.number }}"
        run: |
          git config --global user.email "bot@innosol.online"
          git config --global user.name "Bridge Bot"
          
          # Create a branch for this PR (e.g., pr-5)
          git checkout -b $PR_BRANCH
          
          # Force push to Gitea to trigger the pipeline
          echo "ðŸš€ Pushing to Gitea..."
          git push -f "$TARGET_URL" $PR_BRANCH

      - name: Comment on GitHub
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: "âœ… **Code Mirrored to Private Factory!**\n\nThe `safe-to-test` label was detected.\n- **Status:** Running internal CI.\n- **Action:** Maintainers will review the results in Gitea."
            })

      - name: Pre-Register Status Checks
        uses: actions/github-script@v6
        with:
          script: |
            const checks = ['Gitea/Fast-Feedback', 'Gitea/Heavy-Validation'];
            for (const check_name of checks) {
              await github.rest.repos.createCommitStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha: context.payload.pull_request.head.sha,
                state: 'pending',
                context: check_name,
                description: 'Waiting for Gitea Runner...'
              });
            }
