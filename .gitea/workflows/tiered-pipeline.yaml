name: "Tiered AI Pipeline"

on:
  push:
    branches: [main, dev]
    # Trigger 7: Manual Checkout

jobs:
  fast-feedback:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Manual Checkout
        run: |
          echo "â¬‡ï¸ Cloning repository manually..."
          git clone --depth 1 https://git:${{ github.token }}@gitea.innosol.online/${{ github.repository }}.git .
          echo "âœ… Checkout complete"
          
      - name: Security Scan
        run: |
          echo "ğŸ”’ Scanning for exposed secrets..."
          if grep -rE "(RUNNER_TOKEN|API_KEY|SECRET_KEY|PASSWORD|PRIVATE_KEY)=" --include="*.py" --include="*.yml" --include="*.yaml" . 2>/dev/null | grep -v ".env.example" | grep -v ".gitignore"; then
            echo "âŒ SECURITY VIOLATION: Secrets found!"
            exit 1
          fi
          echo "âœ… No secrets detected"
          
      - name: Verify .env Not Tracked
        run: |
          if git ls-files --error-unmatch .env 2>/dev/null; then
            echo "âŒ SECURITY VIOLATION: .env is tracked!"
            exit 1
          fi
          echo "âœ… .env is NOT tracked"
          
      - name: Lint with Ruff
        uses: docker://ghcr.io/astral-sh/ruff:latest
        with:
          args: check invisible_core/ app_interface/ --ignore E501,E402
          
      - name: Check Import Structure
        run: |
          if grep -rn "from src\." --include="*.py" invisible_core/ app_interface/; then
            echo "âŒ Found old 'from src.' imports!"
            exit 1
          fi
          echo "âœ… All imports use new structure"

  heavy-validation:
    needs: fast-feedback
    if: success()
    runs-on: linux_cpu_heavy
    steps:
      - name: Manual Checkout
        run: |
          echo "â¬‡ï¸ Cloning repository manually..."
          git clone --depth 1 https://git:${{ github.token }}@gitea.innosol.online/${{ github.repository }}.git .
          echo "âœ… Checkout complete"

      - name: Build Test Environment
        run: |
          echo "ğŸ³ Building CI Image..."
          docker build -t safespace-ci:latest -f Dockerfile.ci .

      - name: Run Pytest
        run: |
          echo "ğŸ§ª Running Tests..."
          docker run --rm \
            -v $(pwd)/tests:/app/tests \
            safespace-ci:latest \
            pytest tests/ --maxfail=1

